<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Using BigRQuery on GCP AI Platform Notebooks  &#8211; Zain Rizvi's blog</title>
<meta name="description" content="When you're using Jupyter Notebooks with R, authenticating with BigQuery can be tricky.  Here's how to do it.">
<meta name="keywords" content="BigRQuery, BigQuery, Jupyter Lab, R, Google Cloud Platform, technical">




<!-- Twitter Cards -->
<meta name="twitter:title" content="Using BigRQuery on GCP AI Platform Notebooks ">
<meta name="twitter:description" content="When you're using Jupyter Notebooks with R, authenticating with BigQuery can be tricky.  Here's how to do it.">
<meta name="twitter:site" content="@zainrzv">
<meta name="twitter:creator" content="@zainrzv">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Using BigRQuery on GCP AI Platform Notebooks ">
<meta property="og:description" content="When you're using Jupyter Notebooks with R, authenticating with BigQuery can be tricky.  Here's how to do it.">
<meta property="og:url" content="http://localhost:4000/blog/authenticating-to-bigrquery-on-gcp-ai-platform-notebooks/">
<meta property="og:site_name" content="Zain Rizvi's blog">

<meta property="og:image" content="http://localhost:4000/images/default-thumb.png">






<link rel="canonical" href="http://localhost:4000/blog/authenticating-to-bigrquery-on-gcp-ai-platform-notebooks/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Zain Rizvi's blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<!-- <link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png"> -->
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png"> -->
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png"> -->
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png"> -->

<!-- add the applause button style & script -->
<link rel="stylesheet" href="https://unpkg.com/applause-button/dist/applause-button.css" />
<script src="https://unpkg.com/applause-button/dist/applause-button.js"></script>

<!-- RSS feed metadata -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zain Rizvi's blog" />

<!-- MailerLite Universal -->
<script>
  (function(m,a,i,l,e,r){ m['MailerLiteObject']=e;function f(){
  var c={ a:arguments,q:[]};var r=this.push(c);return "number"!=typeof r?r:f.bind(c.q);}
  f.q=f.q||[];m[e]=m[e]||f.bind(f.q);m[e].q=m[e].q||f.q;r=a.createElement(i);
  var _=a.getElementsByTagName(i)[0];r.async=1;r.src=l+'?v'+(~~(new Date().getTime()/1000000));
  _.parentNode.insertBefore(r,_);})(window, document, 'script', 'https://static.mailerlite.com/js/universal.js', 'ml');

  var ml_account = ml('accounts', '1765926', 's9l3w3n7b0', 'load');
</script>
<!-- End MailerLite Universal -->

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://localhost:4000/">Zain Rizvi's blog</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li><a href="http://localhost:4000/about/" >About</a></li>
				
				<li>
					<a href="http://localhost:4000/feed.xml"><img src="/images/rss.png" alt="rss feed" height=20 width=20/></a>
				</li>
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="http://localhost:4000/images/bio-photo.png" class="bio-photo" alt="Zain Rizvi bio photo">


  <h3 itemprop="name">Zain Rizvi</h3>
  <p>Software Engineer, Experimenter, Life-long Student. Working at Google improving GCP AI Platform Notebooks</p>
  
  <a href="//twitter.com/zainrzv" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  
  
  
  
  <a href="http://github.com/ZainRizvi" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  <a href="//stackoverflow.com/users/21539/zain-rizvi" class="author-social" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> Stackoverflow</a>
  
  
  
  
  
  
  
  
  
  
  <a href="//techstuff.buzzsprout.com" class="author-social" target="_blank"><i class="fa fa-fw"></i> Podcast: Tech Stuff</a>
</div>
<hr />
<div class="ml-form-embed"
  data-account="1765926:s9l3w3n7b0"
  data-form="1616786:y5z4v2">
</div>

    <hr />
    <!-- https://applause-button.com/ -->

    <div style="margin:0 auto; width: 58px" >
    <applause-button style="width: 58px; height: 58px; align-content: center" multiclap="true"/>
    </div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://localhost:4000/blog/authenticating-to-bigrquery-on-gcp-ai-platform-notebooks/" rel="bookmark" title="Using BigRQuery on GCP AI Platform Notebooks ">Using BigRQuery on GCP AI Platform Notebooks </a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Note: These instructions can be used whenever you’re using Jupyter Lab on a remote machine</p>

<p><a href="https://cloud.google.com/ai-platform-notebooks/">GCP AI Platform Notebooks</a> makes it really easy to run notebooks on Jupyter Lab and even offers R language notebooks.  R is great for crunching large data sets, and a popular place for people to store their data is on BigQuery.</p>

<p>The most popular library for accessing BigQuery in R is the open source library <a href="https://github.com/r-dbi/bigrquery">BigRQuery</a>.  It’s an extremely useful library, but it has the downside that the authentication step will try one of two things:</p>

<ol>
  <li>It either will prompt people for extra input on the command line</li>
  <li>Or open up a port on http://localhost to listen for GCP authentication</li>
</ol>

<p>#1 doesn’t work with any Jupter  Notebook since they are not designed to accept extra commands in the middle of an execution</p>

<p>#2 won’t work if you’re connected to Jupyter Lab on a remote machine (the http://localhost will point you to the wrong VM!)</p>

<p>Since neither of the normal ways to authenticate yourself will work <a href="https://github.com/r-dbi/bigrquery/issues/340">just yet</a>, this post describes two different methods you can use to authenticate yourself to BigQuery within a AI Platform Notebook:</p>

<ol>
  <li>Authenticate using your normal GCP user credentials</li>
  <li>Authenticate using a service account</li>
</ol>

<h1 id="prereq-create-an-ai-platform-notebook-for-r">Prereq: Create an AI Platform Notebook for R</h1>

<p>First create a new AI Platform notebook. This notebook is where you’ll be trying to use BigRQuery</p>

<ol>
  <li>Go to <a href="http://console.cloud.google.com/mlengine/notebooks/instances" title="http://console.cloud.google.com/mlengine/notebooks/instances">http://console.cloud.google.com/mlengine/notebooks/instances</a></li>
  <li>Select ‘New Instance’ -&gt; ‘R 3.x’ -&gt; Create</li>
  <li>Wait for the notebook to be created and click “OPEN JUPYTERLAB”</li>
</ol>

<h1 id="option-1-authenticating-using-your-gcp-user-credentials">Option #1: Authenticating using your GCP user credentials</h1>

<p>This method uses the Jupter Lab terminal to run the interactive commands and cache the credentials. Once you’re authenticated, you can switch to a notebook and it’ll use the credentials in the cache.</p>

<p>First, start R in a Terminal</p>

<p><img src="/media/2019-08-05-b1.png" alt="" /></p>

<p>Run <code class="highlighter-rouge">R</code></p>

<p>You’ll get the output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter@r-20190802-172922:\~$ R

R version 3.6.1 (2019-07-05) -- "Action of the Toes"
Copyright (C) 2019 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.
</code></pre></div></div>

<p>Next we install the required packages</p>

<p>As of this writing, BigRQuery needs the dev version of gargle for this authentication to work.  Later you shouldn’t need to explicitly install gargle.</p>

<p>Run the following commands to install the packages:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install.packages("httpuv")
install.packages("devtools")
devtools::install_github("r-lib/gargle") # get the dev version of gargle
install.packages("bigrquery")
install.packages("readr") # To read BigQuery results
</code></pre></div></div>

<p>Those packages will take ~10 minutes to install</p>

<p>Import the required libraries and Authenticate yourself by running the command <code class="highlighter-rouge">bq</code><code class="highlighter-rouge">_auth(use_</code><code class="highlighter-rouge">oob = TRUE)</code> (correct your email address as appropriate)</p>

<p>Commands to run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(httpuv)
library(gargle)
library(bigrquery)
bq_auth(use_oob = TRUE)
</code></pre></div></div>

<p>Say yes when it asks about caching the OAuth credentials.</p>

<p>You’ll see an error like the following</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; library(httpuv)
&gt; library(gargle)
&gt; library(bigrquery)
&gt; bq_auth(use_oob = TRUE)
&gt; Is it OK to cache OAuth access credentials in the folder '/home/jupyter/.R/gargle/gargle-oauth' between R sessions?

1: Yes
2: No

Selection: 1
Enter authorization code: /usr/bin/xdg-open: 778: /usr/bin/xdg-open: www-browser: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: links2: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: elinks: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: links: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: lynx: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: w3m: not found
xdg-open: no method available for opening 'https://accounts.google.com/o/oauth2/auth?client_id=603366585132-0l3n5tr582q443rnomebdeeo0156b2bc.apps.googleusercontent.com&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fbigquery%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&amp;response_type=code'
</code></pre></div></div>

<ol>
  <li>
    <p>Here’s where it gets tricky.  It’ll look like it’s only giving a list of errors. But if you look closely the error contains a url you see an https://accounts.google.com url in their.  Copy/paste that url into a new window and you’ll see the usual Google Auth page.</p>

    <p><img src="/media/2019-08-05-b2.png" alt="" /></p>
  </li>
</ol>

<p>Log in and give Tidyverse the permissions it’s requesting.  It’ll take you to a screen giving you a secret code:</p>

<p><img src="/media/2019-08-05-b3.png" alt="" /></p>

<p>Copy that code and paste  it into your JupyterLab terminal and hit Enter.</p>

<p>I know, it doesn’t look like the terminal is waiting for any kind of input, but it actually is (hopefully gargle will fix this soon).</p>

<p>Sample output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; library(httpuv)
&gt; library(gargle)
&gt; library(bigrquery)
&gt; bq_auth(use_oob = TRUE)
Is it OK to cache OAuth access credentials in the folder '/home/jupyter/.R/gargle/gargle-oauth' between R sessions?

1: Yes
2: No

Selection: 1
Enter authorization code: /usr/bin/xdg-open: 778: /usr/bin/xdg-open: www-browser: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: links2: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: elinks: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: links: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: lynx: not found
/usr/bin/xdg-open: 778: /usr/bin/xdg-open: w3m: not found
xdg-open: no method available for opening 'https://accounts.google.com/o/oauth2/auth?client_id=603366585132-0l3n5tr582q443rnomebdeeo0156b2bc.apps.googleusercontent.com&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fbigquery%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&amp;response_type=code'
4/lgjskDFGSjkwETSgsjGSKEJTssfgKWlgjskDFGSjkwETSgsjGSKEJTssfgKWlgjsk &lt;===== the GCP auth code I copy/pasted in
&gt;
</code></pre></div></div>

<p>Now you can verify that your credentials have actually been cached.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; bq_auth(use_oob = TRUE) &lt;===== retrying the auth to see if it worked
The bigrquery package is requesting access to your Google account. Select a pre-authorised account or enter '0' to obtaina new token. Press Esc/Ctrl + C to abort.

1: xxxxxxx@gmail.com  &lt;===== The auth credentials were cached

Selection: 1
</code></pre></div></div>

<p>If you now try to authenticate to bigrquery using your email, it’ll work (if bq_auth() returns with no message then that means it worked. Not the most intuitive, I know)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; bq_auth(email="xxxxxxx@gmail.com")
&gt;
</code></pre></div></div>

<p>Now you can create a new R notebook within Jupyter Lab and authenticate yourself!</p>

<p>Create a new R notebook:</p>

<p><img src="/media/2019-08-05-b4.png" alt="" /></p>

<p>Run the following code within your notebook. It’ll pull the authentication credentials for the given email addresses from the cache saved earlier:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(httpuv)
library(gargle)
library(bigrquery)

bq_auth(email="xxxxxxx@gmail.com")

project_id &lt;- 'my-project-id'
test_query_text &lt;- "SELECT * FROM `bigquery-public-data.usa_names.usa_1910_current` LIMIT 10"

test_results &lt;- query_exec(test_query_text, project_id, use_legacy_sql = FALSE)

test_results # print the results
</code></pre></div></div>

<h1 id="option-2-authenticate-using-a-service-account">Option 2: Authenticate using a Service Account</h1>

<p>This method involves creating a new service account in GCP, saving the key for that service account on your notebook, and using that key to authenticate to GCP.</p>

<p>Full instructions for using this method are available here:</p>

<p><a href="https://cloud.google.com/ml-engine/docs/notebooks/use-r-bigquery#create_a_service_account_key" title="https://cloud.google.com/ml-engine/docs/notebooks/use-r-bigquery#create_a_service_account_key">https://cloud.google.com/ml-engine/docs/notebooks/use-r-bigquery#create_a_service_account_key</a></p>

      <hr />
      <br/>
      <!-- https://applause-button.com/ -->

    <div style="margin:0 auto; width: 58px" >
    <applause-button style="width: 58px; height: 58px; align-content: center" multiclap="true"/>
    </div>

      <br/>
      <div class="ml-form-embed"
  data-account="1765926:s9l3w3n7b0"
  data-form="1616590:u0m8l0">
</div>


      <hr/>

      <footer role="contentinfo">
        
<!--
<div class="social-share">
  <h5>Thanks for reading! If you found this post valuable, your followers might also like it</h5>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/blog/authenticating-to-bigrquery-on-gcp-ai-platform-notebooks/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/blog/authenticating-to-bigrquery-on-gcp-ai-platform-notebooks/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
  </ul>
</div>
-->
<!-- /.social-share -->

        <p class="byline"><strong>Using BigRQuery on GCP AI Platform Notebooks </strong> was published on <time datetime="2019-08-05T00:00:00-07:00">August 05, 2019</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->


  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://localhost:4000/blog/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://localhost:4000/blog/jupyter-notebooks-best-practices-use-virtual-environments/" title="Use Virtual Environments Inside Jupyter Notebooks & Jupter Lab [Best Practices]">Use Virtual Environments Inside Jupyter Notebooks & Jupter Lab [Best Practices]</a></li>
    
      <li><a href="http://localhost:4000/blog/authenticating-ai-platform-notebooks-against-bigquery-in-python/" title="Authenticating AI Platform Notebooks against BigQuery in Python">Authenticating AI Platform Notebooks against BigQuery in Python</a></li>
    
      <li><a href="http://localhost:4000/blog/a-more-beautiful-question-summary/" title="A More Beautiful Question - Key Insights">A More Beautiful Question - Key Insights</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>&copy; 2019 Zain Rizvi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'zainrizvi'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63901701-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>
