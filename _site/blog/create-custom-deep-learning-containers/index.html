<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>How to Create Customized Deep Learning Containers &#8211; Zain Rizvi's blog</title>
<meta name="description" content="Ever find yourself needing to install the same packages on all your deep learning notebooks? Or maybe wishing you could send your exact setup to someone else who could run your notebook? 

I explore how you can create a custom Docker Container to contain your exact desired Deep Learning environment. Specifically, I'll cover creating Tensorflow with GPU support for R, but you can use these steps for any customization you want">
<meta name="keywords" content="Deep Learning, GCP, Google Cloud Platform, AI Platform Notebooks, Jupyter Lab, Tensorflow, GPU, R Language">




<!-- Twitter Cards -->
<meta name="twitter:title" content="How to Create Customized Deep Learning Containers">
<meta name="twitter:description" content="Ever find yourself needing to install the same packages on all your deep learning notebooks? Or maybe wishing you could send your exact setup to someone else who could run your notebook? 

I explore how you can create a custom Docker Container to contain your exact desired Deep Learning environment. Specifically, I'll cover creating Tensorflow with GPU support for R, but you can use these steps for any customization you want">
<meta name="twitter:site" content="@zainrzv">
<meta name="twitter:creator" content="@zainrzv">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="How to Create Customized Deep Learning Containers">
<meta property="og:description" content="Ever find yourself needing to install the same packages on all your deep learning notebooks? Or maybe wishing you could send your exact setup to someone else who could run your notebook? 

I explore how you can create a custom Docker Container to contain your exact desired Deep Learning environment. Specifically, I'll cover creating Tensorflow with GPU support for R, but you can use these steps for any customization you want">
<meta property="og:url" content="http://localhost:4000/blog/create-custom-deep-learning-containers/">
<meta property="og:site_name" content="Zain Rizvi's blog">

<meta property="og:image" content="http://localhost:4000/images/default-thumb.png">






<link rel="canonical" href="http://localhost:4000/blog/create-custom-deep-learning-containers/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Zain Rizvi's blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<!-- <link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png"> -->
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png"> -->
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png"> -->
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<!-- <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png"> -->

<!-- add the applause button style & script -->
<link rel="stylesheet" href="https://unpkg.com/applause-button/dist/applause-button.css" />
<script src="https://unpkg.com/applause-button/dist/applause-button.js"></script>

<!-- RSS feed metadata -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zain Rizvi's blog" />

<!-- MailerLite Universal -->
<script>
  (function(m,a,i,l,e,r){ m['MailerLiteObject']=e;function f(){
  var c={ a:arguments,q:[]};var r=this.push(c);return "number"!=typeof r?r:f.bind(c.q);}
  f.q=f.q||[];m[e]=m[e]||f.bind(f.q);m[e].q=m[e].q||f.q;r=a.createElement(i);
  var _=a.getElementsByTagName(i)[0];r.async=1;r.src=l+'?v'+(~~(new Date().getTime()/1000000));
  _.parentNode.insertBefore(r,_);})(window, document, 'script', 'https://static.mailerlite.com/js/universal.js', 'ml');

  var ml_account = ml('accounts', '1765926', 's9l3w3n7b0', 'load');
</script>
<!-- End MailerLite Universal -->

<!-- Google Analytics -->
<!--<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', '', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
-->
<!-- Asynchronous Google Analytics snippet -->

  <script>
    var _gaq = _gaq || [];
    var pluginUrl =
   '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
    _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
    _gaq.push(['_setAccount', 'UA-63901701-1']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://localhost:4000/">Zain Rizvi's blog</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
				
				    
				    <li><a href="http://localhost:4000/about/" >About</a></li>
				
				<li>
					<a href="http://localhost:4000/feed.xml"><img src="/images/rss.png" alt="rss feed" height=20 width=20/></a>
				</li>
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="http://localhost:4000/images/bio-photo.png" class="bio-photo" alt="Zain Rizvi bio photo">


  <h3 itemprop="name">Zain Rizvi</h3>
  <p>Software Engineer @ Google, ex-Microsoftie. Experimenter, Life-long Student. Working to improve GCP AI Platform Notebooks. Opinions are all my own</p>
  
  <a href="//twitter.com/zainrzv" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  
  
  
  
  <a href="http://github.com/ZainRizvi" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  <a href="//stackoverflow.com/users/21539/zain-rizvi" class="author-social" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> Stackoverflow</a>
  
  
  
  
  
  
  
  
  
  
  <a href="//techstuff.buzzsprout.com" class="author-social" target="_blank"><i class="fa fa-fw"></i> Podcast: Tech Stuff</a>
</div>
<hr />
<div class="ml-form-embed"
  data-account="1765926:s9l3w3n7b0"
  data-form="1616786:y5z4v2">
</div>

    <hr />
    <!-- https://applause-button.com/ -->

    <div style="margin:0 auto; width: 58px" >
    <applause-button style="width: 58px; height: 58px; align-content: center" multiclap="true"/>
    </div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://localhost:4000/blog/create-custom-deep-learning-containers/" rel="bookmark" title="How to Create Customized Deep Learning Containers">How to Create Customized Deep Learning Containers</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
     
      

<section id="table-of-contents" class="toc">
<div id="drawer" markdown="1">
<ul>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#download-a-container">Download a container</a></li>
  <li><a href="#steps">Steps</a>
    <ul>
      <li><a href="#1-create-your-image">1. Create your image</a></li>
      <li><a href="#2-push-your-image-to-a-repository">2. Push your image to a repository</a></li>
      <li><a href="#3-customize-your-image">3. Customize your image</a></li>
    </ul>
  </li>
  <li><a href="#use-your-image">Use your image!</a></li>
  <li><a href="#it-wasnt-all-roses-and-rainbows">It wasn’t all Roses and Rainbows</a>
    <ul>
      <li><a href="#key-differences-encountered">Key differences encountered:</a></li>
      <li><a href="#key-productivity-hacks-discovered">Key productivity hacks discovered:</a></li>
    </ul>
  </li>
</ul>

</div>
</section><!-- /#table-of-contents -->
      
      <p>Ever find yourself needing to install the same packages on all your deep learning notebooks? Or maybe wishing you could send your exact setup to someone else who could run your notebook? Or perhaps you’re a corporation which wants all your data scientists to have some internal libraries on all their notebooks.</p>

<p>Turns out you can. GCP’s <a href="https://cloud.google.com/ai-platform-notebooks/">AI Platform Notebooks team</a> offers <a href="https://cloud.google.com/ai-platform/deep-learning-containers/">Deep Learning Containers</a>, which is a containerized version of the exact same images you get when you create a regular AI Platform Notebook (full disclosure: that’s <a href="https://zainrizvi.io/about/">my team</a>).</p>

<p>And those containers are 100% free</p>

<p>Why would you want to use one? A quick list of benefits you can expect by using these:</p>

<ul>
  <li>Ability to run these deep learning environments anywhere, including directly on your laptop</li>
  <li>Have your favorite libraries pre-installed by default. You avoid having to customize your notebook environment every time you create a new notebook</li>
  <li>Have a consistent environment used by all of your data scientists</li>
  <li>Ability to modify or replace the default Jupyter Lab IDE (if you really want to)</li>
</ul>

<p>Below I’ll be walking you through the steps I took to create a Jupyter Lab container that lets you run Tensorflow with GPUs, but you can modify these instructions to meet your own exact needs.</p>

<p><strong>Disclaimer</strong>: While my team offers the Deep Learning containers (among other products), I myself have never used containers before.  So the below is the results of my first real experimentation and if you know of better ways to achieve what I’m doing please let me know in the comments!</p>

<p>At the bottom of the post are the key lessons I learned:</p>

<ul>
  <li>Differences between DLVM images and DL Container images</li>
  <li>Some productivity hacks for working with Dockerfiles</li>
</ul>

<h1 id="prerequisites"><strong>Prerequisites</strong></h1>

<p>In order to follow along with the rest of the post I’ll assume you have the following installed on your computer:</p>

<ul>
  <li>docker</li>
  <li>gcloud (optional)</li>
</ul>

<h1 id="download-a-container"><strong>Download a container</strong></h1>

<p>Let’s take a quick look at what containers we have available to us by running</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcloud container images list <span class="nt">--repository</span><span class="o">=</span><span class="s2">"gcr.io/deeplearning-platform-release"</span>
</code></pre></div></div>

<p>Currently that command outputs:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcloud container images list <span class="nt">--repository</span><span class="o">=</span><span class="s2">"gcr.io/deeplearning-platform-release"</span>
NAME
gcr.io/deeplearning-platform-release/base-cpu
gcr.io/deeplearning-platform-release/base-cu100
gcr.io/deeplearning-platform-release/beam-notebooks
gcr.io/deeplearning-platform-release/pytorch-cpu
gcr.io/deeplearning-platform-release/pytorch-cpu.1-0
gcr.io/deeplearning-platform-release/pytorch-cpu.1-1
gcr.io/deeplearning-platform-release/pytorch-cpu.1-2
gcr.io/deeplearning-platform-release/pytorch-cpu.1-3
gcr.io/deeplearning-platform-release/pytorch-gpu
gcr.io/deeplearning-platform-release/pytorch-gpu.1-0
gcr.io/deeplearning-platform-release/pytorch-gpu.1-1
gcr.io/deeplearning-platform-release/pytorch-gpu.1-2
gcr.io/deeplearning-platform-release/pytorch-gpu.1-3
gcr.io/deeplearning-platform-release/r-cpu
gcr.io/deeplearning-platform-release/r-cpu.3-6
gcr.io/deeplearning-platform-release/tf-cpu
gcr.io/deeplearning-platform-release/tf-cpu.1-13
gcr.io/deeplearning-platform-release/tf-cpu.1-14
gcr.io/deeplearning-platform-release/tf-cpu.1-15
gcr.io/deeplearning-platform-release/tf-gpu
gcr.io/deeplearning-platform-release/tf-gpu.1-13
gcr.io/deeplearning-platform-release/tf-gpu.1-14
gcr.io/deeplearning-platform-release/tf-gpu.1-15
gcr.io/deeplearning-platform-release/tf2-cpu
gcr.io/deeplearning-platform-release/tf2-cpu.2-0
gcr.io/deeplearning-platform-release/tf2-gpu
gcr.io/deeplearning-platform-release/tf2-gpu.2-0
</code></pre></div></div>

<p>That’s a list of all the different environments available for you to choose from. You can see Tensorflow, Pytorch, R, and others on the list, and most of them come in both CPU and GPU variations.</p>

<p>We’ll take the Tensorflow 2 CPU image and modify it to create our custom environment.  My goal here is to create a containerized version of an R environment with support for using GPUs with Tensorflow available out of the box.  <a href="https://zainrizvi.io/blog/using-gpus-with-r-in-jupyter-lab/">I previously walked through a script</a> that does all this for you on a AI Platform Notebook, but that script took tens of minutes to run and who has time to wait that long for each of their notebooks?</p>

<p>This solution will hopefully get us to the point where we get both of those things available in two minutes.</p>

<h1 id="steps"><strong>Steps</strong></h1>

<p><em>You can follow along these instructions by cloning the</em> <a href="https://github.com/ZainRizvi/UseRWithGpus/" title="https://github.com/ZainRizvi/UseRWithGpus/"><em>https://github.com/ZainRizvi/UseRWithGpus/</em></a> <em>repository and running the below commands from there</em></p>

<h2 id="1-create-your-image">1. Create your image</h2>

<p>We’ll create a super simple image first. We’ll use the Tensorflow 2 CPU image as our base and not change anything other than adding our own name as the maintainer of the new image.</p>

<p>To do this, create a dockerfile and give it the following contents</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> gcr.io/deeplearning-platform-release/tf2-gpu</span>
<span class="k">LABEL</span><span class="s"> maintainer="Zain Rizvi"</span>
</code></pre></div></div>

<p><strong><em>Note</em></strong><em>: I named my dockerfile</em> <a href="https://github.com/ZainRizvi/UseRWithGpus/blob/master/dockerfiles/tensorflow-2-gpu.Dockerfile"><em>tensorflow-2-gpu.Dockerfile</em></a> <em>and put it under the “dockerfiles” subdirectory, and will be using that for the rest of my examples. But convention is to just name your dockerfile “Dockerfile”</em></p>

<p>Now cd to the directory that contains that file and run <code class="highlighter-rouge">docker build . -f dockerfiles\tensorflow-2-gpu.Dockerfiles</code> And Docker will download that image from the GCP repository, apply your custom label to it, and save the resulting image locally.</p>

<p><strong><em>Note</em></strong><em>: If you name your dockerfile “Dockerfile” and place it in your current directory, you can skip the</em> <code class="highlighter-rouge">-f [filename\]</code> <em>parameter.</em></p>

<p>You’ll see something similar to the following</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-f</span> dockerfiles<span class="se">\t</span>ensorflow-2-gpu.Dockerfiles
Sending build context to Docker daemon 2.048kB
Step 1/2 : FROM gcr.io/deeplearning-platform-release/tf2-cpu
latest: Pulling from deeplearning-platform-release/tf2-cpu
35c102085707: Already exists
251f5509d51d: Already exists
…
928e12577c37: Pull <span class="nb">complete
</span>48d9ceba06f1: Pull <span class="nb">complete
</span>Digest: sha256:88ae24914e15f2df11a03486668e9051ca85b65f8577358e7d965ce6a146f217
Status: Downloaded newer image <span class="k">for </span>gcr.io/deeplearning-platform-release/tf2-cpu:latest
<span class="nt">---</span><span class="o">&gt;</span> e493f17c90d0
Step 2/2 : LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"Zain Rizvi"</span>
<span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>561cbb80b0c5
Removing intermediate container 561cbb80b0c5
<span class="nt">---</span><span class="o">&gt;</span> 8cee7adcf9c3
Successfully built 8cee7adcf9c3
</code></pre></div></div>

<p>Note the id in the last line <code class="highlighter-rouge">Successfully built 8cee7adcf9c3</code>. That <code class="highlighter-rouge">8cee7adcf9c3</code> is a local image id, and it will be important when we want to push our image (a couple steps down).</p>

<h2 id="2-push-your-image-to-a-repository">2. Push your image to a repository</h2>

<p>To push your image, you need a registry to push it to. I’ll assume you’re using Docker Hub (which is free for public registries) but you can use whatever registry provider you prefer. For a Docker Hub registry you can go to <a href="hub.docker.com">hub.docker.com</a> and create your public registry. You’ll need to create an account first though if you don’t have one already</p>

<p>Before the push, make sure you’re logged into docker from within the console (enter your password when prompted):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker login <span class="nt">--username</span> zainrizvi
</code></pre></div></div>

<p>Now to push we need to tell docker which image it should be pushing to our new registry. We do this by tagging the image we built with the path of our registry and add an optional tag (yeah, the overload of the word ‘tag’ is a bit annoying).</p>

<p>Remember that image Id I told you to note earlier (mine was <strong><code class="highlighter-rouge">8cee7adcf9c3</code></strong>), now is when you need that Id. We’ll tag that Id with the path to the repository we want to use:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker tag <span class="o">[</span>ImageId] <span class="o">[</span>repo-name]:[image-tag]
</code></pre></div></div>

<p>Example:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker tag 8cee7adcf9c3 zainrizvi/deeplearning-container-tf2-with-r:latest-gpu
</code></pre></div></div>

<p>If you run docker images you should now see an image with that repository and tag</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
zainrizvi/deeplearning-container-tf2-with-r latest-gpu 8cee7adcf9c3 4 minutes ago 6.26GB
</code></pre></div></div>

<p>However, just because we’ve tagged the image doesn’t mean it actually exists in the repository. We have to do a docker push to get it in there:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker push zainrizvi/deeplearning-container-tf2-with-r
</code></pre></div></div>

<p>And now if you go to your docker registry you’ll see that the image is there for anyone to view and download</p>

<p>So that was cool, but we didn’t really do anything special. We’re not pre-configuring any of the packages we really need or anything like that.</p>

<p>Let’s now add some actual customizations to this image</p>

<h2 id="3-customize-your-image"><strong>3. Customize your image</strong></h2>

<p>Let’s extend this Dockerfile to support using Tensorflow with GPUs on an R notebook.</p>

<p>I’ve shared a few scripts on GitHub which can install R onto your AI Platform Notebooks, but those script takes way too long to run them every time you make a new notebook. Instead, I’d rather run the script in a container just once, and then save that container for future notebooks.</p>

<p>The scripts referenced below are chunks of logic I pulled out from these <a href="https://github.com/ZainRizvi/UseRWithGpus/blob/master/install-r-gpu.sh">master</a> <a href="https://github.com/ZainRizvi/UseRWithGpus/blob/master/install-r-cpu.sh">scripts</a>. You can read more about what those scripts do <a href="https://zainrizvi.io/blog/using-gpus-with-r-in-jupyter-lab/">in this blog post on using R with GPUs</a> . Splitting the logic into multiple scripts made this stuff much easier to debug (what problems did I run into that had to be debugged? I’ll tell you about it in a future post).</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> gcr.io/deeplearning-platform-release/tf2-gpu</span>
<span class="k">LABEL</span><span class="s"> maintainer="Zain Rizvi"</span>

<span class="k">RUN </span>apt update <span class="nt">-y</span>
<span class="k">RUN </span><span class="nb">mkdir </span>steps
<span class="k">COPY</span><span class="s"> steps/* /steps/</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /steps/<span class="k">*</span>

<span class="k">RUN </span>/steps/1-Install-generic-dependencies.sh
<span class="k">RUN </span>/steps/2-register-with-r-repository-ubuntu.sh
<span class="k">RUN </span>/steps/3-Install-R-and-IRkernel.sh
<span class="k">RUN </span>/steps/4-Install-common-R-packages.sh <span class="nt">-m</span> GPU
<span class="k">RUN </span>/steps/5-Add-rpy2-support.sh
<span class="k">RUN </span>/steps/6-Install-keras.sh
</code></pre></div></div>

<p>And now we can run <code class="highlighter-rouge">docker build . -f dockerfiles\tensorflow-2-gpu.Dockerfiles</code> again. This time the command will take a <strong>long</strong> time to complete (because some of those steps are sloooooow).</p>

<p>But once it completes, we’ll again be given a new image Id similar to the one we saw earlier. Just tag that and push it to your registry the same way we did before</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker tag xxxxxxxxxxxxx zainrizvi/deeplearning-container-tf2-with-r:latest-gpu
<span class="nv">$ </span>docker push zainrizvi/deeplearning-container-tf2-with-r
</code></pre></div></div>

<p>And now your image is available to use on your registry</p>

<h1 id="use-your-image">Use your image!</h1>

<p>To use your newly created image on AI Platform Notebooks:</p>

<ol>
  <li>Go to the <a href="https://console.cloud.google.com/ai-platform/notebooks/">notebooks page</a> -&gt; New Instance -&gt; Customize Instance</li>
</ol>

<p><img src="/media/2019-12-13-custom-instance.png" alt="" /></p>

<ol>
  <li>Under the environment drop down select “Custom container”</li>
</ol>

<p>Then in the “Docker container image” box enter the path to the registry you pushed your image to. Mine is: zainrizvi/deeplearning-container-tf2-with-r:latest-gpu</p>

<p><img src="/media/2019-12-13-custom-container.png" alt="" /></p>

<ol>
  <li>
    <p>Click create, and in few minutes your notebook will be ready. You can open it up and see that TensorFlow is ready to go</p>

    <p><img src="/media/2019-12-13-running-notebook-1.png" alt="" /></p>
  </li>
</ol>

<p>And there you go, you now have an R notebook that can run Tensorflow on GPUs!</p>

<h1 id="it-wasnt-all-roses-and-rainbows">It wasn’t all Roses and Rainbows</h1>

<p>The more astute among you may have noticed that while <a href="https://zainrizvi.io/blog/using-gpus-with-r-in-jupyter-lab/">the script I previously demoed</a> was just, well, a single script, the dockerfile above contains six different scripts which seem to be the original script split into six parts.  The eagle eyed may even notice that some parts of the script have been slightly changed, and that I’m no longer compiling XGboost.</p>

<p>Turns out the Deep Learning VM images and Deep Learning Containers are note quiiiiite 100% identical…</p>

<h2 id="key-differences-encountered"><strong>Key differences encountered:</strong></h2>

<ul>
  <li>VM images run on Debian OS while containers run on Ubuntu</li>
  <li>Container images don’t the CUDA compiler installed, which is (surprise)  required to compile GPU binaries. It contains all the binaries required for runtime though. Turns out those were omitted in order to reduce the size of the docker container.</li>
  <li>[mild] Containers get very confused if you give them a command that starts with “sudo”. Not a big deal since every command in a container runs as ‘sudo’ anyways</li>
</ul>

<p>This led to a lot of time spent debugging what I had thought was a solved problem.  (And did I mention this was my first time using docker containers?). Which led to…</p>

<h2 id="key-productivity-hacks-discovered"><strong>Key productivity hacks discovered:</strong></h2>

<ul>
  <li>In your dockerfile, split up your mega script into multiple smaller scripts.  Docker will ‘cache’ the results of your previous, successful scripts and restart the build from the script that was changed (downside: this adds more layers to your docker image, but there are workarounds)</li>
  <li>Edit on the go: If you setup docker hub to pull your code from github and build the image, you can make minor 1-minute fixes from your phone directly on github, commit, and go about your day while docker hub starts a new build run (which may take 2-4 hours to complete…Docker hub is slowwwwww. But it’s free, and enables this nice productivity hack)</li>
</ul>

<p>If you’d like to hear about the craziness I encountered debugging this image (it was over 7 hours of debugging + waiting for scripts to run), sign up on the form below to get an email when that article comes out.</p>

      <hr />
      <br/>
      <!-- https://applause-button.com/ -->

    <div style="margin:0 auto; width: 58px" >
    <applause-button style="width: 58px; height: 58px; align-content: center" multiclap="true"/>
    </div>

      <br/>
      <div class="ml-form-embed"
  data-account="1765926:s9l3w3n7b0"
  data-form="1616590:u0m8l0">
</div>


      <hr/>

      <footer role="contentinfo">
        
<!--
<div class="social-share">
  <h5>Thanks for reading! If you found this post valuable, your followers might also like it</h5>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/blog/create-custom-deep-learning-containers/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/blog/create-custom-deep-learning-containers/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
  </ul>
</div>
-->
<!-- /.social-share -->

        <p class="byline"><strong>How to Create Customized Deep Learning Containers</strong> was published on <time datetime="2019-12-17T00:00:00-08:00">December 17, 2019</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->

  </article>
  
  
  <div class="related-articles">
  <h3>You might also enjoy <small class="pull-right">(<a href="http://localhost:4000/blog/">View all posts</a>)</small></h3>
    <ul>
    
      <li><a href="http://localhost:4000/blog/remembering-what-you-read-zettelkasten-vs-para/" title="Remembering what you read: Zettelkasten vs PARA">Remembering what you read: Zettelkasten vs PARA</a></li>
    
      <li><a href="http://localhost:4000/blog/quickly-building-products-for-actual-customers/" title="Quickly Building Products for ACTUAL Customers">Quickly Building Products for ACTUAL Customers</a></li>
    
      <li><a href="http://localhost:4000/blog/the-truth-about-vpc-security-controls/" title="The Truth about VPC Security Controls">The Truth about VPC Security Controls</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  


  <section id="disqus_thread"></section><!-- /#disqus_thread -->

</div><!-- /#main -->

<div class="footer-wrap">
  <footer>
    

<span>&copy; 2020 Zain Rizvi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'zainrizvi'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>





</body>
</html>
